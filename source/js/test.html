<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Poincaré Disk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
</head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-transition.v1.min.js"></script>
<script src="https://d3js.org/d3-shape.v1.min.js"></script>

<body> 
    <div class="display-1 text-center">
        <h1>Poincaré Disk Explorer</h1>
    </div>
    <div class="container">
        <div class="row" style="height: 600px">
            <div class="col-sm-1">
            </div>
            <div class="col col-sm-6 h-100" style="height:600px">
                <div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-default active line-button">Line</button>
                        <button type="button" class="btn btn-default circle-button">Circle</button>
                    </div> 
                </div>
                <div class="mainbox">
                </div>
            </div>
            <div class="col-sm-3" style="height:600px">
                <div class="well well-sm">
                    <p>
                    <strong>Coordinates</strong>
                    <div class="coordinates" style="height:10px"></div>
                    </p>
                </div>
                <div class="well well-sm" style="height:500px">
                    <strong>Elements</strong>
                    <div class="elements"></div>
                </div>
            </div>
            <div class="col-sm-2">
            </div>
        </div>
    </div> 
</body> 
</html>

<script type="text/javascript">
var w = window.innerWidth,
    h = window.innerHeight;

// Create main window and poincare disk
var svg = d3.select(".mainbox").append("svg").attrs({
    width: w,
    height: h
})

var cx = 250,
    cy = 250,
    r = 200

var unitCircleAttrib = {
    cx: cx,
    cy: cy,
    r: r,
    stroke: "black",
    strokewidth: "2",
    fill: "white",
    opacity: "1.0"
}

var unitCircle = svg.append("circle")
                    .attrs(unitCircleAttrib)


// Handle line/circle buttons
var drawType = "line"
d3.select(".line-button")
  .classed("active", true)
  .on("click", function(d, i) { 
      drawType = "line"
      d3.select(".line-button")
        .classed("active", true)
      d3.select(".circle-button")
        .classed("active", false)
  });
d3.select(".circle-button")
  .classed("active", false)
  .on("click", function(d, i) { 
      drawType = "circle"
      d3.select(".circle-button")
        .classed("active", true);
      d3.select(".line-button")
        .classed("active", false);
  });


// Coordinate Transformations 
function canvasToDisk(coord) {
    x = Math.round(coord.x - unitCircleAttrib.cx) / unitCircleAttrib.r
    y = -Math.round(coord.y - unitCircleAttrib.cy) / unitCircleAttrib.r

    if (x*x + y*y < 1.0) {
        return {x: x, y: y}
    } else {
        return null
    }
}

function diskToCanvas(coord) {
    x = coord.x * unitCircleAttrib.r + unitCircleAttrib.cx
    y = -coord.y * unitCircleAttrib.r + unitCircleAttrib.cy
    return {x: x, y: y}
}

// Hyperbolic lines
function computeHyperbolicLine(p, q) {
    // Infinite case
    if (p.x == 0 && p.y == 0 && q.x == 0 && q.y == 0) {
        return null
    }

    function lineEqn(p, q) {
        return {a: (p.y - q.y), b: (q.x - p.x), c: (p.x * q.y - q.x * p.y)}
    }

    function perpLine(pq, P) {
        return {a: pq.b, b: -pq.a, c: -P.x * pq.b + P.y * pq.a}
    }

    function dist(p, q) {
        return Math.sqrt(Math.pow(p.x - q.x, 2) + Math.pow(p.y - q.y, 2))
    }

    function midpoint(p, q) {
        return {x: (p.x + q.x) / 2, y: (p.y + q.y) / 2}
    }

    function inversion(p) {
        pDist = dist(p, {x: 0, y: 0})
        c = 1. / (pDist * pDist)
        pp = {x: c * p.x , y: c * p.y}
        console.log("ppDist = ", dist(pp, {x:0, y:0}))
        console.log("pp = ", pp)
        return pp
    }

    function intersectLines(l1, l2) {
        a = l1.a
        b = l1.b
        c = l1.c
        j = l2.a
        k = l2.b
        l = l2.c
        return {
            x: (c * k - b * l) / (b * j - a * k),
            y: (a * l - c * j) / (b * j - a * k)
        }
    }

    P = canvasToDisk(p)
    Q = canvasToDisk(q)

    // Algorithm from:
    // https://en.wikipedia.org/wiki/Poincar%C3%A9_disk_model#Compass_and_straightedge_construction
    PQ = lineEqn(P, Q)
    M = midpoint(P, Q)
    m = perpLine(PQ, M)
    console.log("P", P)
    console.log("Q", Q)
    console.log("PQ", PQ)
    console.log("m", m)
    Pprime = inversion(P)
    console.log("P", P, "  Pprime", Pprime)
    N = midpoint(P, Pprime)
    console.log("N", N)
    // console.log("P Pprime", lineEqn(P, Pprime))
    n = perpLine(lineEqn(P, Pprime), N)
    console.log("n", n)
    C = intersectLines(n, m)
    console.log("C", C)
   
    function atan2(y, x) {
        angle = Math.atan2(y, x)
        console.log("atan2", angle)
        return (angle >= 0 ? angle : (2*Math.PI + angle))
    }

    startAngle = atan2(P.y - C.y, P.x - C.x)
    endAngle = atan2(Q.y - C.y, Q.x - C.x)

    return {
        center: diskToCanvas(C),
        startAngle: startAngle, 
        endAngle: endAngle,
        radius: dist(diskToCanvas(C), diskToCanvas(P))
    }
}

// Globals
var coordbox = d3.select(".coordinates");
var elements = d3.select(".elements");
var allObjects = [];
var isMouseDown = false;
var tmpObject = null;

function drawObjects() {
    if (drawType == "line") {
        data = allObjects.filter(x => x.type == "line")
                         .concat(tmpObject);

        //sel = g.selectAll(".line")
        //       .data(data)

        //sel.exit()
        //   .remove();

        g.selectAll(".line-start")
         .data(data)
         .exit()
         .remove()

        g.selectAll(".line-start")
         .data(data)
         .enter()
         .append("circle")
         .attr("class", function(d) { return "line-start " + d.id})
         .attr("cx", function(d) { console.log(d.p); return d.p.x; })
         .attr("cy", function(d) { return d.p.y; })
         .style("fill", "black")
         .attr("r", 3)

        g.selectAll(".line-end")
         .data(data)
         .remove()

        g.selectAll(".line-end")
         .data(data)
         .enter()
         .append("circle")
         .attr("class", function(d) { return "line-end " + d.id})
         .attr("cx", function(d) { console.log(d.q); return d.q.x; })
         .attr("cy", function(d) { return d.q.y; })
         .style("fill", "black")
         .attr("r", 3)

        g.selectAll(".line-arc")
         .data(data)
         .remove()

        g.selectAll(".line-arc")
         .data(data)
         .enter()
         .append("path")
         .attr("class", function(d) { return "line-arc " + d.id})
         .attr("transform", function(d) { 
             hline = computeHyperbolicLine(d.p, d.q)
             return "translate(" + hline.center.x + "," + hline.center.y + ")"
         })
         .style("fill", "black")
         .attr("d", function(d) { 
             hline = computeHyperbolicLine(d.p, d.q)
             console.log(hline)
             radius = hline.radius
             arcGenerator = d3.arc()
                              .innerRadius(radius)
                              .outerRadius(radius+1)
                              .startAngle(hline.startAngle)
                              .endAngle(hline.endAngle)
             return arcGenerator()
         })



        function computeArc(d) {
            return "M";
        }
    }
}

function drawElementsBox() {
    sel = elements.selectAll(".elementitem")
                  .data(allObjects)

    if (drawType == "line") {
        function lineToText(d) {
            if (drawType == "line") {
                p = canvasToDisk(d.p)
                q = canvasToDisk(d.q)
                return d.id + ": " +
                    "P: (" + p.x + ", " + p.y + "), " +
                    "Q: (" + q.x + ", " + q.y + ")";
            }
        }

        sel.exit()
           .remove();

        sel.enter()
           .append("div")
           .attr("class", "elementitem")
           .text(function(d) { 
               return lineToText(d)
        });
    }
}


function mousedown() {
    d3.event.preventDefault(); // disable text dragging

    canvasCoord = {x: d3.mouse(this)[0], y: d3.mouse(this)[1]}
    diskCoord = canvasToDisk(canvasCoord)
    if (!diskCoord)
        return

    isMouseDown = true;
    tmpObject = getTmpObject(canvasCoord, canvasCoord)

    drawObjects()
}


function mousemove() {
    canvasCoord = {x: d3.mouse(this)[0], y: d3.mouse(this)[1]}
    coord = canvasToDisk(canvasCoord)
    if (coord) {
        coordbox.text("[" + coord.x.toFixed(3) + ", " + coord.y.toFixed(3) + "] - " + isMouseDown)

        if (isMouseDown) {
            tmpObject = getTmpObject(tmpObject.p, canvasCoord)

            drawObjects()
        }
    } else {
        coordbox.text("")
        isMouseDown = false
    }
}


function getTmpObject(p, q) {
    label = drawType + "-" + (allObjects.filter(x => x.type == drawType).length + 1).toString();
    return {"id": label, "type": drawType, "p": p, "q": q}
}


function mouseup() {
    isMouseDown = false

    canvasCoord = {x: d3.mouse(this)[0], y: d3.mouse(this)[1]}
    coord = canvasToDisk(canvasCoord)

    if (coord) {
        allObjects.push(tmpObject)
        drawElementsBox()
    } else {
        tmpObject = []
    }
}

svg.on("mousedown", mousedown)
   .on("mouseup", mouseup)
   .on("mousemove", mousemove)

var g = svg.append("g");

</script>


<!--
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-ease.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
-->

