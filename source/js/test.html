<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Poincaré Disk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
</head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-transition.v1.min.js"></script>
<!-- <script src="https://d3js.org/d3-shape.v1.min.js"></script> -->
<script src="helpers.js"></script>

<body> 
    <div class="display-1 text-center">
        <h1>Poincaré Disk Explorer</h1>
    </div>
    <div class="container">
        <div class="row" style="height: 600px">
            <div class="col-sm-1">
            </div>
            <div class="col col-sm-6 h-100" style="height:600px">
                <div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-default active line-button">Line</button>
                        <button type="button" class="btn btn-default circle-button">Circle</button>
                    </div> 
                </div>
                <div class="mainbox">
                </div>
            </div>
            <div class="col-sm-3" style="height:600px">
                <div class="well well-sm">
                    <p>
                    <strong>Element Info</strong>
                    <div class="coordinates" style="height:10px"></div>
                    <br/>
                    <div class="distance" style="height:10px"></div>
                    </p>
                </div>
                <div class="well well-sm" style="height:500px">
                    <strong>Elements</strong>
                    <div class="elements"></div>
                </div>
            </div>
            <div class="col-sm-2">
            </div>
        </div>
    </div> 
</body> 
</html>

<script type="text/javascript">
// Globals
var w = window.innerWidth,
    h = window.innerHeight;

var main_x = 250,
    main_y = 250,
    main_radius = 200

var unitCircleAttrib = {
    cx: main_x,
    cy: main_y,
    r: main_radius,
    stroke: "black",
    strokewidth: "2",
    fill: "white",
    opacity: "1.0"
}

var elements = d3.select(".elements");
var allObjects = [];
var isMouseDown = false;
var tmpObject = null;

// Create main window and poincare disk
var svg = d3.select(".mainbox").append("svg").attrs({
    width: w,
    height: h
})
var unitCircle = svg.append("circle")
                    .attrs(unitCircleAttrib)


// Handle line/circle buttons
var drawType = "line"
d3.select(".line-button")
  .classed("active", true)
  .on("click", function(d, i) { 
      drawType = "line"
      d3.select(".line-button")
        .classed("active", true)
      d3.select(".circle-button")
        .classed("active", false)
  });

d3.select(".circle-button")
  .classed("active", false)
  .on("click", function(d, i) { 
      drawType = "circle"
      d3.select(".circle-button")
        .classed("active", true);
      d3.select(".line-button")
        .classed("active", false);
  });


function drawObjects() {
    if (drawType == "line") {
        data = allObjects.filter(x => x.type == "line")

        tmpData = null
        if (tmpObject != null && tmpObject.p != null && tmpObject.q != null) {
            data = data.concat(tmpObject);
            hline = computeHyperbolicLine(tmpObject.p, tmpObject.q,
                                          {x: main_x, y: main_y}, main_radius)
            tmpData = [hline];
        }

        g.selectAll(".line-start")
         .remove()

        g.selectAll(".line-start")
         .data(data)
         .enter()
         .append("circle")
         .attr("class", function(d) { return "line-start " + d.id})
         .attr("cx", function(d) { return d.p.x; })
         .attr("cy", function(d) { return d.p.y; })
         .style("fill", "black")
         .attr("r", 3)

        g.selectAll(".line-end")
         .remove()

        g.selectAll(".line-end")
         .data(data)
         .enter()
         .append("circle")
         .attr("class", function(d) { return "line-end " + d.id})
         .attr("cx", function(d) { return d.q.x; })
         .attr("cy", function(d) { return d.q.y; })
         .style("fill", "black")
         .attr("r", 3)

        g.selectAll(".line-arc")
         .remove()

        g.selectAll(".line-arc")
         .data(data)
         .enter()
         .append("path")
         .attr("class", function(d) { return "line-arc " + d.id})
         .style("fill", "none")
         .style("stroke", "blue")
         .style("stroke-width", "2")
         .attr("d", function(d) { 
             hline = computeHyperbolicLine(d.p, d.q, {x: main_x, y: main_y}, main_radius)
             radius = hline.radius
             return describeArc(hline.center.x, hline.center.y, hline.radius,
                                hline.startAngle, hline.endAngle)
         })

        g.selectAll(".fadeCircle")
         .remove()
        if (tmpData) {
            g.selectAll(".fadeCircle")
             .data(tmpData)
             .enter()
             .append("circle")
             .attr("class", "fadeCircle")
             .attr("cx", function(hline) { 
                 return hline.center.x; 
             })
             .attr("cy", function(hline) {
                 return hline.center.y; 
             })
             .style("stroke", "blue")
             .style("stroke-width", "2")
             .style("opacity", "0.2")
             .style("fill", "none")
             .attr("r", function(hline) {
                return hline.radius;
             })
        }

    }
}

function drawElementsBox() {
    sel = elements.selectAll(".elementitem")
                  .data(allObjects)

    if (drawType == "line") {
        function lineToText(d) {
            if (drawType == "line") {
                p = canvasToDisk(d.p)
                q = canvasToDisk(d.q)
                return d.id + ": " +
                    "P: (" + p.x + ", " + p.y + "), " +
                    "Q: (" + q.x + ", " + q.y + ")";
            }
        }

        sel.exit()
           .remove();

        sel.enter()
           .append("div")
           .attr("class", "elementitem")
           .text(function(d) { 
               return lineToText(d)
           });
    }
}


function mousedown() {
    d3.event.preventDefault(); // disable text dragging

    canvasCoord = {x: d3.mouse(this)[0], y: d3.mouse(this)[1]}
    diskCoord = canvasToDisk(canvasCoord)
    if (!diskCoord)
        return

    isMouseDown = true;
    tmpObject = getTmpObject(canvasCoord, canvasCoord)
    drawObjects()
}

function drawInfoBox(canvasCoord) {
    diskCoord = canvasToDisk(canvasCoord);
    coordText = "";
    distText = "";

    if (diskCoord != null) {
        if (!isMouseDown) {
            coordText = "[" + diskCoord.x.toFixed(3) + ", " + diskCoord.y.toFixed(3) + "]";
            distText = "";
        } else {
            coordText = ("P: [" + tmpObject.p.x.toFixed(3) + ", " + tmpObject.p.y.toFixed(3) + "]" +
                         "Q: [" + tmpObject.q.x.toFixed(3) + ", " + tmpObject.q.y.toFixed(3) + "]"
                        );
            dist = hDist(canvasToDisk(tmpObject.p), canvasToDisk(tmpObject.q));
            distText = "Hyperbolic Distance: " + dist.toFixed(3);
        }
    }

    d3.select(".coordinates").text(coordText);
    d3.select(".distance").text(distText);
}

function mousemove() {
    canvasCoord = {x: d3.mouse(this)[0], y: d3.mouse(this)[1]}
    if (!canvasToDisk(canvasCoord)) {
        isMouseDown = false
        tmpObject = null
    } else if (isMouseDown && canvasCoord != null) {
        tmpObject = getTmpObject(tmpObject.p, canvasCoord)
    }

    if (canvasCoord != null) {
        drawInfoBox(canvasCoord);
        drawObjects();
    }
}


function getTmpObject(p, q) {
    label = drawType + "-" + (allObjects.filter(x => x.type == drawType).length + 1).toString();
    return {"id": label, "type": drawType, "p": p, "q": q}
}


function mouseup() {
    isMouseDown = false

    canvasCoord = {x: d3.mouse(this)[0], y: d3.mouse(this)[1]}
    diskCoord = canvasToDisk(canvasCoord)

    if (diskCoord && tmpObject != null) {
        allObjects.push(tmpObject)
        drawElementsBox()
    }

    tmpObject = []
    g.selectAll(".fadeCircle")
     .data([1])
     .remove()
}

var g = svg.append("g");
svg.on("mousedown", mousedown)
   .on("mouseup", mouseup)
   .on("mousemove", mousemove)


</script>


<!--
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-ease.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
-->

