<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Poincaré Disk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
</head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-selection.v1.min.js"></script>
<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
<script src="https://d3js.org/d3-transition.v1.min.js"></script>

<body> 
    <div class="display-1 text-center">
        <h1>Poincaré Disk Explorer</h1>
    </div>
    <div class="container">
        <div class="row" style="height: 600px">
            <div class="col-sm-1">
            </div>
            <div class="col col-sm-6 h-100" style="height:600px">
                <div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-default active line-button">Line</button>
                        <button type="button" class="btn btn-default circle-button">Circle</button>
                    </div> 
                </div>
                <div class="mainbox">
                </div>
            </div>
            <div class="col-sm-3" style="height:600px">
                <div class="well well-sm">
                    <p>
                    <strong>Coordinates</strong>
                    <div class="coordinates" style="height:10px"></div>
                    </p>
                </div>
                <div class="well well-sm" style="height:500px">
                    <strong>Elements</strong>
                    <div class="elements"></div>
                </div>
            </div>
            <div class="col-sm-2">
            </div>
        </div>
    </div> 
</body> 
</html>

<script type="text/javascript">
var w = window.innerWidth,
    h = window.innerHeight;

// Create main window and poincare disk
var svg = d3.select(".mainbox").append("svg").attrs({
    width: w,
    height: h
})

var cx = 250,
    cy = 250,
    r = 200

var unitCircle = svg.append("circle")
                    .attrs({
                        cx: cx,
                        cy: cy,
                        r: r,
                        stroke: "black",
                        strokewidth: "2",
                        fill: "white",
                        opacity: "1.0"
                    })


// Handle line/circle buttons
var drawType = "line"
d3.select(".line-button")
  .classed("active", true)
  .on("click", function(d, i) { 
      drawType = "line"
      d3.select(".line-button")
        .classed("active", true)
      d3.select(".circle-button")
        .classed("active", false)
  });
d3.select(".circle-button")
  .classed("active", false)
  .on("click", function(d, i) { 
      drawType = "circle"
      d3.select(".circle-button")
        .classed("active", true);
      d3.select(".line-button")
        .classed("active", false);
  });


// Coordinate Transformations 
function canvasToDisk(coord) {
    x = Math.round(coord.x - cx) / r
    y = Math.round(coord.y - cy) / r

    if (x*x + y*y < 1.0) {
        return {x: x, y: y}
    } else {
        return null
    }
}

function diskToCanvas(coord) {
    if (coord.x * coord.x + coord.y * coord.y < 1.0) {
        x = coord.x * r + cx
        y = coord.y * r + cy
        return {x: x, y: y}
    } else {
        return null
    }
}

// Globals
var coordbox = d3.select(".coordinates");
var elements = d3.select(".elements");
var lineObjects = [];
var circleObjects = [];
var allObjects = [];
var isMouseDown = false;
var tmpObject = [];

function drawObjects(label, drawType) {
    if (drawType == "line") {
        sel = g.selectAll("." + label)
               .data(lineObjects.concat(tmpObject));

        sel.exit()
           .remove();
        
        sel.attr("class", label)
           .attr("r", 5)
           .attr("cx", function(d) { return d.x; })
           .attr("cy", function(d) { return d.y; })
           .style("fill", "black");
        
        sel.enter()
           .append("circle")
           .attr("class", label)
           .attr("cx", function(d) { console.log(d); return d.x; })
           .attr("cy", function(d) { console.log(d); return d.y; })
           .style("fill", "black")
           .attr("r", 5);

        function computeArc(d) {
            return "M";
        }

        sel.enter()
           .append("path")
           .attr("d", computeArc())
           .style("stroke", "black");
    }
}

function drawElementsBox() {
    sel = elements.selectAll(".elementitem")
                  .data(allObjects)

    if (drawType == "line") {
        function lineToText(d) {
            if (drawType == "line") {
                p = canvasToDisk(d.p)
                q = canvasToDisk(d.q)
                return d.id + ": " +
                    "P: (" + p.x + ", " + p.y + "), " +
                    "Q: (" + q.x + ", " + q.y + ")";
            }
        }

        sel.exit()
           .remove();

        sel.text(function(d) { return lineToText(d) });
        
        sel.enter()
           .append("div")
           .attr("class", "elementitem")
           .text(function(d) { 
               //console.log(d); 
               return lineToText(d)
        });
    }
}


function mousedown() {
    d3.event.preventDefault(); // disable text dragging

    canvasCoord = {x: d3.mouse(this)[0], y: d3.mouse(this)[1]}
    diskCoord = canvasToDisk(canvasCoord)
    if (!diskCoord)
        return

    isMouseDown = true;
    tmpObject = getTmpObject(canvasCoord, canvasCoord)

    objects = drawType == "line" ? lineObjects : circleObjects;
    label = drawType + "-" + (objects.length + 1).toString();
    drawObjects(label, drawType)
}


function mousemove() {
    canvasCoord = {x: d3.mouse(this)[0], y: d3.mouse(this)[1]}
    coord = canvasToDisk(canvasCoord)
    if (coord) {
        coordbox.text("[" + coord.x.toFixed(3) + ", " + coord.y.toFixed(3) + "] - " + isMouseDown)

        if (isMouseDown) {
            tmpObject = getTmpObject(tmpObject.p, canvasCoord)

            objects = drawType == "line" ? lineObjects : circleObjects;
            label = drawType + "-" + (objects.length + 1).toString();
            drawObjects(label, drawType)
        }
    } else {
        coordbox.text("")
        isMouseDown = false
    }
}


function getTmpObject(p, q) {
    objects = drawType == "line" ? lineObjects : circleObjects;
    label = drawType + "-" + (objects.length + 1).toString();
    return {"id": label, "p": p, "q": q}
}


function mouseup() {
    isMouseDown = false

    canvasCoord = {x: d3.mouse(this)[0], y: d3.mouse(this)[1]}
    coord = canvasToDisk(canvasCoord)

    if (coord) {
        obj = (drawType == "line") ? lineObjects : circleObjects;
        obj.push(tmpObject)
        allObjects.push(tmpObject)

        drawElementsBox()
    } else {
        tmpObject = []
    }
}

svg.on("mousedown", mousedown)
   .on("mouseup", mouseup)
   .on("mousemove", mousemove)

var g = svg.append("g");

</script>


<!--
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-ease.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>
-->

